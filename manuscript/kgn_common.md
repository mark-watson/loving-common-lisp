# Knowledge Graph Navigator Common Library Implementation {#kgncommon}


The Knowledge Graph Navigator (which I will often refer to as KGN) is a tool for processing a set of entity names and automatically exploring the public Knowledge Graph [DBPedia](http://dbpedia.org) using SPARQL queries. I started to write KGN for my own use, to automate some things I used to do manually when exploring Knowledge Graphs, and later thought that KGN might be also useful for educational purposes. KGN shows the user the auto-generated SPARQL queries so hopefully the user will learn by seeing examples. KGN uses NLP code developed in earlier chapters and we will reuse that code with a short review of using the APIs.

In previous versions of this book, this example was hard-wired to use LispWork CAPI for the user interface. This old version is in **src/kgn** in the main GitHub repository for this book: [https://github.com/mark-watson/loving-common-lisp](https://github.com/mark-watson/loving-common-lisp) and has a few UI components like a progress bar that I removed since the previous edition. The new version has separate GitHub repositories for:

- [https://github.com/mark-watson/kgn-common](https://github.com/mark-watson/kgn-common) for the Knowledge Graph Navigator common library. 
- [https://github.com/mark-watson/kgn-text-ui](https://github.com/mark-watson/kgn-text-ui) for a text interface for the Knowledge Graph Navigator. 
- [https://github.com/mark-watson/kgn-capi-ui](https://github.com/mark-watson/kgn-capi-ui) for a LispWorks CAPI GUI interface for the Knowledge Graph Navigator.

If you followed the code example setup instructions in the book Preface or in the README file in the main repo [https://github.com/mark-watson/loving-common-lisp](https://github.com/mark-watson/loving-common-lisp) then all three of these projects are available for loading via Quicklisp on your computer.

After looking at SPARQL generated by this example for an example query, we will start a process of bottom up development, first writing low level functions to automate SPARQL queries, writing utilities we will need for the UIs developed in later chapters.

Since the DBPedia SPARQL queries are time consuming, we will also implement a caching layer using SQLite that will make the app more responsive. The cache is especially helpful during development when the same queries are repeatedly used for testing.

The code for this reusable library is in the directory **src/kgn-common**. This is common library that will be used for user interfaces developed in later chapters. There is a lot of code in the following program listings and I hope to provide you with a roadmap overview of the code, diving in on code that you might want to reuse for your own projects and some representative code for generating SPARQL queries.

Let's start by looking at the files for the common library:

- Makefile - contains development shortcuts.
- data - data used to remove stop words from text.
- kgn-common.lisp - main code file for library.
- package.lisp - standard Common Lisp package definition.
- utils.lisp - miscelanious utility functions.
- README.txt
- kgn-common.asd - standard Common Lisp ASDF definition.


## Example Output

Before we get started studying the implementation, let's look at sample output in order to help give meaning to the code we will look at later. Consider a query that a user might type into the top query field in the KGN app:

        Steve Jobs lived near San Francisco and was
        a founder of <http://dbpedia.org/resource/Apple_Inc.>

The system will try to recognize entities in a query. If you know the DBPedia URI of an entity, like the company Apple in this example, you can use that directly. Note that in the SPARQL  URIs are surrounded with angle bracket characters.

The application prints out automatically generated SPARQL queries. For the above listed example query the following output will be generated (some editing to fit page width):

{linenos=off}
~~~~~~~~
Trying to get entity by name = Steve Jobs using SPARQL with type:
~~~~~~~~
{lang="sparql",linenos=off}
~~~~~~~~
select distinct ?s ?comment { ?s ?p "Steve Jobs"@en . 
 ?s <http://www.w3.org/2000/01/rdf-schema#comment> ?comment .
   FILTER ( lang ( ?comment ) = 'en' ) . 
 ?s <http://www.w3.org/1999/02/22-rdf-syntax-ns#type>
    <http://dbpedia.org/ontology/Person> . 
 } LIMIT 15 
~~~~~~~~

{linenos=off}
~~~~~~~~
Trying to get entity by name = San Francisco using SPARQL with type:
~~~~~~~~
{lang="sparql",linenos=off}
~~~~~~~~
select distinct ?s ?comment { ?s ?p "San Francisco"@en . 
 ?s <http://www.w3.org/2000/01/rdf-schema#comment> ?comment . 
   FILTER ( lang ( ?comment ) = 'en' ) . 
 ?s <http://www.w3.org/1999/02/22-rdf-syntax-ns#type>
    <http://dbpedia.org/ontology/City> . 
 } LIMIT 15 
~~~~~~~~

{linenos=off}
~~~~~~~~
SPARQL to get PERSON data for <http://dbpedia.org/resource/Steve_Jobs>:
~~~~~~~~
{lang="sparql",linenos=off}
~~~~~~~~
SELECT DISTINCT ?label ?comment 
 ( GROUP_CONCAT ( DISTINCT ?birthplace ; SEPARATOR=' | ' ) AS ?birthplace ) 
 ( GROUP_CONCAT ( DISTINCT ?almamater ; SEPARATOR=' | ' ) AS ?almamater ) 
 ( GROUP_CONCAT ( DISTINCT ?spouse ; SEPARATOR=' | ' ) AS ?spouse ) { 
 <http://dbpedia.org/resource/Steve_Jobs> 
   <http://www.w3.org/2000/01/rdf-schema#comment>
   ?comment . 
 FILTER ( lang ( ?comment ) = 'en' ) . 
 OPTIONAL { <http://dbpedia.org/resource/Steve_Jobs>
            <http://dbpedia.org/ontology/birthPlace>
            ?birthplace } . 
 OPTIONAL { <http://dbpedia.org/resource/Steve_Jobs> 
            <http://dbpedia.org/ontology/almaMater> 
            ?almamater } . 
 OPTIONAL { <http://dbpedia.org/resource/Steve_Jobs> 
            <http://dbpedia.org/ontology/spouse> 
            ?spouse } . 
 OPTIONAL { <http://dbpedia.org/resource/Steve_Jobs> 
            <http://www.w3.org/2000/01/rdf-schema#label> 
            ?label . 
 FILTER ( lang ( ?label ) = 'en' ) } 
 } LIMIT 10 
~~~~~~~~

Remember, the SPARQL is generated by KGN from natural language queries. Some more examples:

{linenos=off}
~~~~~~~~
SPARQL to get CITY data for <http://dbpedia.org/resource/San_Francisco>:
~~~~~~~~
{lang="sparql",linenos=off}
~~~~~~~~
SELECT DISTINCT ?label ?comment 
 ( GROUP_CONCAT ( DISTINCT ?latitude_longitude ; SEPARATOR=' | ' ) 
     AS ?latitude_longitude ) 
 ( GROUP_CONCAT ( DISTINCT ?populationDensity ; SEPARATOR=' | ' ) 
     AS ?populationDensity ) 
 ( GROUP_CONCAT ( DISTINCT ?country ; SEPARATOR=' | ' ) 
     AS ?country ) { 
 <http://dbpedia.org/resource/San_Francisco> 
   <http://www.w3.org/2000/01/rdf-schema#comment>
   ?comment . 
      FILTER ( lang ( ?comment ) = 'en' ) . 
 OPTIONAL { <http://dbpedia.org/resource/San_Francisco> 
            <http://www.w3.org/2003/01/geo/wgs84_pos#geometry> 
            ?latitude_longitude } . 
 OPTIONAL { <http://dbpedia.org/resource/San_Francisco> 
            <http://dbpedia.org/ontology/PopulatedPlace/populationDensity> 
            ?populationDensity } . 
 OPTIONAL { <http://dbpedia.org/resource/San_Francisco> 
            <http://dbpedia.org/ontology/country> 
            ?country } . 
 OPTIONAL { <http://dbpedia.org/resource/San_Francisco> 
            <http://www.w3.org/2000/01/rdf-schema#label> 
            ?label . } 
 } LIMIT 30 
~~~~~~~~
{linenos=off}
~~~~~~~~
SPARQL to get COMPANY data for <http://dbpedia.org/resource/Apple_Inc.>:
~~~~~~~~
{lang="sparql",linenos=off}
~~~~~~~~
SELECT DISTINCT ?label ?comment ( GROUP_CONCAT ( DISTINCT ?industry ; SEPARATOR=' | ' ) 
      AS ?industry ) 
 ( GROUP_CONCAT ( DISTINCT ?netIncome ; SEPARATOR=' | ' ) 
      AS ?netIncome ) 
 ( GROUP_CONCAT ( DISTINCT ?numberOfEmployees ; SEPARATOR=' | ' ) 
      AS ?numberOfEmployees ) { 
 <http://dbpedia.org/resource/Apple_Inc.> 
    <http://www.w3.org/2000/01/rdf-schema#comment> ?comment . 
 FILTER ( lang ( ?comment ) = 'en' ) . 
 OPTIONAL { <http://dbpedia.org/resource/Apple_Inc.> 
            <http://dbpedia.org/ontology/industry> 
            ?industry } . 
 OPTIONAL { <http://dbpedia.org/resource/Apple_Inc.> 
            <http://dbpedia.org/ontology/netIncome> ?netIncome } . 
 OPTIONAL { <http://dbpedia.org/resource/Apple_Inc.> 
            <http://dbpedia.org/ontology/numberOfEmployees> ?numberOfEmployees } . 
 OPTIONAL { <http://dbpedia.org/resource/Apple_Inc.> 
            <http://www.w3.org/2000/01/rdf-schema#label> ?label . 
              FILTER ( lang ( ?label ) = 'en' ) } 
 } LIMIT 30 
~~~~~~~~

Once KGN has identified DBPedia entire URIs, it also searches for relationships between these entities:

{linenos=off}
~~~~~~~~
DISCOVERED RELATIONSHIP LINKS:
~~~~~~~~
{lang="sparql",linenos=off}
~~~~~~~~
<http://dbpedia.org/resource/Steve_Jobs>    ->
    <http://dbpedia.org/ontology/birthPlace>    ->
    <http://dbpedia.org/resource/San_Francisco>
<http://dbpedia.org/resource/Steve_Jobs>    -> 
    <http://dbpedia.org/ontology/occupation>    -> 
    <http://dbpedia.org/resource/Apple_Inc.>
<http://dbpedia.org/resource/Steve_Jobs>    -> 
    <http://dbpedia.org/ontology/board>         -> 
    <http://dbpedia.org/resource/Apple_Inc.>
<http://dbpedia.org/resource/Steve_Jobs>    -> 
    <http://www.w3.org/2000/01/rdf-schema#seeAlso> -> 
    <http://dbpedia.org/resource/Apple_Inc.>
<http://dbpedia.org/resource/Apple_Inc.>    -> 
    <http://dbpedia.org/property/founders>      -> 
    <http://dbpedia.org/resource/Steve_Jobs>
~~~~~~~~

After listing the generated SPARQL for finding information for the entities in the query, KGN searches for relationships between these entities. These discovered relationships can be seen at the end of the last listing. Please note that this step makes SPARQL queries on **O(n^2)** where **n** is the number of entities. Local caching of SPARQL queries to DBPedia helps make processing many entities possible.

In addition to showing generated SPARQL and discovered relationships in the middle text pane of the application, KGN also generates formatted results that are also displayed in the bottom text pane:

{linenos=off}
~~~~~~~~

- - - ENTITY TYPE: PEOPLE - - -

LABEL: Steve Jobs

COMMENT: Steven Paul "Steve" Jobs was an American information technology 
entrepreneur and inventor. He was the co-founder, chairman, and chief 
executive officer (CEO) of Apple Inc.; CEO and majority shareholder
of Pixar Animation Studios; a member of The Walt Disney Company's 
board of directors following its acquisition of Pixar; and founder, 
chairman, and CEO of NeXT Inc. Jobs is widely recognized as a pioneer of 
the microcomputer revolution of the 1970s and 1980s, along with Apple 
co-founder Steve Wozniak. Shortly after his death, Jobs's official 
biographer, Walter Isaacson, described him as a "creative entrepreneur 
whose passion for perfection and ferocious drive revolutionized six industries:
personal computers, animated movies, music, phones

BIRTHPLACE: http://dbpedia.org/resource/San_Francisco

ALMAMATER: http://dbpedia.org/resource/Reed_College

SPOUSE: http://dbpedia.org/resource/Laurene_Powell_Jobs

- - - ENTITY TYPE: CITIES - - -

LABEL:  San Francisco

COMMENT: San Francisco, officially the City and County of San Francisco, is the
cultural, commercial, and financial center of Northern California and
the only consolidated city-county in California. San Francisco encompasses a
land area of about 46.9 square miles (121 km2) on the northern end of the 
San Francisco Peninsula, which makes it the smallest county in the state. 
It has a density of about 18,451 people per square mile (7,124 people per km2),
making it the most densely settled large city (population greater than 
200,000) in the state of California and the second-most densely populated 
major city in the United States after New York City. San Francisco is 
the fourth-most populous city in California, after Los Angeles, San Diego, and 
San Jose, and the 13th-most populous cit

LATITUDE--LONGITUDE: POINT(-122.41666412354 37.783332824707)

POPULATION-DENSITY: 7123.97092726667

COUNTRY: http://dbpedia.org/resource/United_States

- - - ENTITY TYPE: COMPANIES - - -

LABEL: Apple Inc.

COMMENT: Apple Inc. is an American multinational technology company headquartered
in Cupertino, 
California, that designs, develops, and sells consumer electronics, 
computer software, and online services. Its hardware products include the 
iPhone smartphone, the iPad tablet computer, the Mac personal computer, the 
iPod portable media player, the Apple Watch smartwatch, and the Apple TV digital 
media player. Apple's consumer software includes the macOS and iOS operating 
systems, the iTunes media player, the Safari web browser, and the iLife and 
iWork creativity and productivity suites. Its online services include the 
iTunes Store, the iOS App Store and Mac App Store, Apple Music, and iCloud.

INDUSTRY: http://dbpedia.org/resource/Computer_hardware | 
          http://dbpedia.org/resource/Computer_software | 
          http://dbpedia.org/resource/Consumer_electronics | 
          http://dbpedia.org/resource/Corporate_Venture_Capital | 
          http://dbpedia.org/resource/Digital_distribution |
          http://dbpedia.org/resource/Fabless_manufacturing

NET-INCOME: 5.3394E10

NUMBER-OF-EMPLOYEES: 115000
~~~~~~~~

Hopefully after reading through sample output and seeing the screen shot of the application, you now have a better idea what this example application does. Now we will look at project configuration and then implementation.

## Project Configuration and Running the Application

The following listing of **kgn.asd** shows the ten packages this example depends on (five of these are also examples in this book, and five are in the public Quicklisp repository):

{lang="lisp",linenos=on}
~~~~~~~~
;;;; knowledgegraphnavigator.asd

((asdf:defsystem #:kgn-common
  :description "common utilities for Knowledge Graph Navigator"
  :author "Mark Watson <markw@markwatson.com>"
  :license "Apache 2"
  :depends-on (#:sqlite #:cl-json #:alexandria #:drakma #:myutils #:entities #:entity-uris #:kbnlp #:sparql-cache)
  :components ((:file "package")
               (:file "utils")
               (:file "kgn-common")))
~~~~~~~~

Listing of **package.lisp**:

{lang="lisp",linenos=on}
~~~~~~~~
;;;; package.lisp

(defpackage #:kgn-common
(:use #:cl #:alexandria #:myutils  #:myutils #:sparql-cache
   #:entities #:entity-uris #:kbnlp)
(:export #:kgn-common #:remove-stop-words        
         #:entity-results->relationship-links
         #:get-entity-data-helper #:handle-URIs-in-query
         #:remove-uris-from-query #:get-URIs-in-query #:display-entity-results
         #:string-shorten #:prompt-string #:dbpedia-get-product-detail
         #:dbpedia-get-person-detail #:dbpedia-get-country-detail
         #:dbpedia-get-city-detail #:dbpedia-get-company-detail #:clean-results
         #:dbpedia-get-entities-by-name #:clean-comment))
~~~~~~~~

We use **ql:quickload** to load the KGN common library and call a few APIs (some output removed for brevity):

{lang="lisp",linenos=on}
~~~~~~~~
$ sbcl
This is SBCL 2.1.10, an implementation of ANSI Common Lisp.
* (ql :kgn-common)
To load "kgn-common":
  Load 1 ASDF system:
    kgn-common
; Loading "kgn-common"
..................
"Starting to load data...." 
"....done loading data." 
To load "sqlite":
  Load 1 ASDF system:
    sqlite
; Loading "sqlite"

To load "cl-json":
  Load 1 ASDF system:
    cl-json
; Loading "cl-json"

To load "drakma":
  Load 1 ASDF system:
    drakma
; Loading "drakma"
[package kgn-common]..
(:kgn-common)
*
*  (kgn-common::dbpedia-get-relationships "<http://dbpedia.org/resource/Bill_Gates>" "<http://dbpedia.org/resource/Microsoft>")
("<http://dbpedia.org/ontology/knownFor>")
*
*  (kgn-common:dbpedia-get-entities-by-name "Bill Gates" "<http://dbpedia.org/ontology/Person>" "<http://schema.org/Person>" :message-stream nil)

(((:s "http://dbpedia.org/resource/Bill_Gates")
  (:comment
   "William Henry Gates III (born October 28, 1955) is an American business magnate, software developer, investor, author, and philanthropist. He is a co-founder of Microsoft, along with his late childhood friend Paul Allen. During his career at Microsoft, Gates held the positions of chairman, chief executive officer (CEO), president and chief software architect, while also being the largest individual shareholder until May 2014. He is considered one of the best known entrepreneurs of the microcomputer revolution of the 1970s and 1980s."))
 ((:s "http://dbpedia.org/resource/Harry_R._Lewis")
  (:comment
   "Harry Roy Lewis (born 1947) is an American computer scientist, mathe 00ADma 00ADti 00ADcian, and uni 00ADver 00ADsity admin 00ADi 00ADstra 00ADtor known for his research in com 00ADpu 00ADta 00ADtional logic, textbooks in theoretical computer science, and writings on computing, higher education, and technology. He is Gordon McKay Professor of Computer Science at Harvard University, and was Dean of Harvard College from 1995 to 2003. A new professorship in Engineering and Applied Sciences, endowed by a former student, will be named for Lewis and his wife upon their retirements."))
 ((:s "http://dbpedia.org/resource/Cascade_Investment")
  (:comment
   "Cascade Investment, L.L.C. is an American holding company and private investment firm headquartered in Kirkland, Washington, United States. It is controlled by Bill Gates, and managed by Michael Larson. More than half of Gates' fortune is held in assets outside his holding of Microsoft shares. Cascade is the successor company to Dominion Income Management, the former investment vehicle for Gates' holdings, which was managed by convicted felon Andrew Evans."))
 ((:s "http://dbpedia.org/resource/Jerry_Dyer")
  (:comment
   "Jerry P. Dyer (born May 3, 1959) is an American politician and former law enforcement officer. He is the 26th and current mayor of Fresno, California. Previously, he served as the chief of the Fresno Police Department."))) 

select distinct ?s ?comment { ?s ?p "Bill Gates"@en . @@ ?s <http://www.w3.org/2000/01/rdf-schema#comment>  ?comment  . FILTER  (lang(?comment) = 'en') . @@ ?s <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://dbpedia.org/ontology/Person> . @@ } LIMIT 15
(((:s "http://dbpedia.org/resource/Bill_Gates")
  (:comment
   "William Henry Gates III (born October 28, 1955) is an American business magnate, software developer, investor, author, and philanthropist. He is a co-founder of Microsoft, along with his late childhood friend Paul Allen. During his career at Microsoft, Gates held the positions of chairman, chief executive officer (CEO), president and chief software architect, while also being the largest individual shareholder until May 2014. He is considered one of the best known entrepreneurs of the microcomputer revolution of the 1970s and 1980s."))
 ((:s "http://dbpedia.org/resource/Harry_R._Lewis")
  (:comment
   "Harry Roy Lewis (born 1947) is an American computer scientist, mathe 00ADma 00ADti 00ADcian, and uni 00ADver 00ADsity admin 00ADi 00ADstra 00ADtor known for his research in com 00ADpu 00ADta 00ADtional logic, textbooks in theoretical computer science, and writings on computing, higher education, and technology. He is Gordon McKay Professor of Computer Science at Harvard University, and was Dean of Harvard College from 1995 to 2003. A new professorship in Engineering and Applied Sciences, endowed by a former student, will be named for Lewis and his wife upon their retirements."))
 ((:s "http://dbpedia.org/resource/Cascade_Investment")
  (:comment
   "Cascade Investment, L.L.C. is an American holding company and private investment firm headquartered in Kirkland, Washington, United States. It is controlled by Bill Gates, and managed by Michael Larson. More than half of Gates' fortune is held in assets outside his holding of Microsoft shares. Cascade is the successor company to Dominion Income Management, the former investment vehicle for Gates' holdings, which was managed by convicted felon Andrew Evans."))
 ((:s "http://dbpedia.org/resource/Jerry_Dyer")
  (:comment
   "Jerry P. Dyer (born May 3, 1959) is an American politician and former law enforcement officer. He is the 26th and current mayor of Fresno, California. Previously, he served as the chief of the Fresno Police Department.")))
* 
~~~~~~~~

In this last example, using **:message-stream nil** effectively turns off printing generated SPARQL queries used by these APIs. You can use **:message-stream t** to see generated SPARQL.

Every time the KGN common library makes a web service call to DBPedia the query and response are cached in a SQLite database in **~/.kgn_cache.db** which can greatly speed up the program, especially in development mode when testing a set of queries. This caching also takes some load off of the public DBPedia endpoint, which is a polite thing to do.


## Review of NLP Utilities Used in Application

Here is a quick review of NLP utilities we saw in an earlier chapter:

- kbnlp:make-text-object
- kbnlp::text-human-names
- kbnlp::text-place-name
- entity-uris:find-entities-in-text
- entity-uris:pp-entities

The following code snippets show example calls to the relevant NLP functions and the generated output:

{lang="lisp",linenos=off}
~~~~~~~~
KGN 39 > (setf text "Bill Clinton went to Canada")
"Bill Clinton went to Canada"

KGN 40 > (setf txtobj (kbnlp:make-text-object text))
#S(TEXT :URL "" :TITLE "" :SUMMARY "<no summary>" :CATEGORY-TAGS (("computers_microsoft.txt" 0.00641) ("religion_islam.txt" 0.00357)) :KEY-WORDS NIL :KEY-PHRASES NIL :HUMAN-NAMES ("Bill Clinton") :PLACE-NAMES ("Canada") :COMPANY-NAMES NIL :TEXT #("Bill" "Clinton" "went" "to" "Canada") :TAGS #("NNP" "NNP" "VBD" "TO" "NNP"))

KGN 41 > (kbnlp::text-human-names txtobj)
("Bill Clinton")

KGN 42 > 
(loop for key being the hash-keys of  (entity-uris:find-entities-in-text text)
  using (hash-value value)
  do (format t "key: ~S value: ~S~%" key value))
key: "people" value: (("Bill Clinton" "<http://dbpedia.org/resource/Bill_Clinton>"))
key: "countries" value: (("Canada" "<http://dbpedia.org/resource/Canada>"))
NIL
~~~~~~~~

The code using **loop** at the end of the last repl listing that prints keys and values of a hash table is from the [Common Lisp Cookbook web site](http://cl-cookbook.sourceforge.net/hashes.html) in the section "Traversing a Hash Table."

## Developing Low-Level SPARQL Utilities

I use the standard command line **curl** utility program with the Common Lisp package **uiop** to make HTML GET requests to the DBPedia public Knowledge Graph and the package **drakma** to url-encode parts of a query. The source code is in a separate Quicklisp library located in **src/sparql-cache/sparql.lisp**. A non-caching library is also available in **src/sparql/sparql.lisp**.

In the following listing of **src/sparql-cache/sparql.lisp**, lines 8, 24, 39, and 55 I use some caching code that we will look at later. The nested **replace-all** statements in lines 12-13 are a kluge to remove Unicode characters that occasionally caused runtime errors in the KGN application.

{lang="lisp",linenos=on}
~~~~~~~~
(in-package #:kgn)

(ql:quickload "cl-json")
(ql:quickload "drakma")

(defun sparql-dbpedia (query)
  (let* (ret
         (cr (fetch-result-dbpedia query))
         (response
          (or
           cr
           (replace-all
            (replace-all
             (uiop:run-program 
              (list
               "curl" 
               (concatenate 'string
                            "https://dbpedia.org/sparql?query="
                            (drakma:url-encode query :utf-8)
                            "&format=json"))
              :output :string)
             "\\u2013" " ")
            "\\u" " "))))
    (save-query-result-dbpedia query response)
    (ignore-errors
      (with-input-from-string
          (s response)
        (let ((json-as-list (json:decode-json s)))
          (setf
           ret
           (mapcar #'(lambda (x)
                       ;;(pprint x)
                       (mapcar #'(lambda (y)
                                   (list (car y) (cdr (assoc :value (cdr y))))) x))
                   (cdr (cadddr (cadr json-as-list))))))))
    ret))

(defun sparql-ask-dbpedia (query)
  (let* ((cr (fetch-result-dbpedia query))
         (response
          (or
           cr
           (replace-all
            (replace-all
             (uiop:run-program 
              (list
               "curl" 
               (concatenate 'string
                            "https://dbpedia.org/sparql?query="
                            (drakma:url-encode query :utf-8)
                            "&format=json"))
              :output :string)
             "\\u2013" " ")
            "\\u" " "))))
    (save-query-result-dbpedia query response)
    (if  (search "true" response)
        t
      nil)))
~~~~~~~~

The code for replacing Unicode characters is messy but prevents problems later when we are using the query results in the example application.

The code **(json-as-list (json:decode-json s))** on line 28 converts a deeply nested JSON response to nested Common Lisp lists. You may want to print out the list to  better understand the **mapcar** expression on lines 31-35. There is no magic to writing expressions like this, in a repl I set **json-as-list** to the results of one query, and I spent a minute or two experimenting with the nested **mapcar** expression to get it to work with my test case.

The implementation for **sparql-ask-dbpedia** in lines 38-58 is simpler because we don't have to fully parse the returned SPARQL query results. A SPARQL **ask** type query returns a true/false answer to a query. We will use this to determine the types of entities in query text. While our NLP library identifies entity types, making additional **ask** queries to DBPedia to verify entity types will provide better automated results.

## Implementing the Caching Layer

While developing KGN and also using it as an end user, many SPARQL queries to DBPedia contain repeated entity names so it makes sense to write a caching layer.  We use a SQLite database "~/.kgn_cache.db" to store queries and responses.

The caching layer is implemented in the file **src/sparql-cache/sparql.lisp** and some of the relevant code is listed here:

{lang="lisp",linenos=on}
~~~~~~~~
;;; SqList caching for SPARQL queries:

(defvar *db-path* (pathname "~/.kgn_cache.db"))

(defun create-dbpedia ()
  (sqlite:with-open-database (d *db-path*)
    (ignore-errors
      (sqlite:execute-single d
        "CREATE TABLE dbpedia (query string  PRIMARY KEY ASC, result string)"))))

(defun save-query-result-dbpedia (query result)
  (sqlite:with-open-database (d *db-path*)
    (ignore-errors
      (sqlite:execute-to-list d
                       "insert into dbpedia (query, result) values (?, ?)"
                       query result))))
(defun fetch-result-dbpedia (query)
  (sqlite:with-open-database (d *db-path*)
    (cadar
     (sqlite:execute-to-list d
                      "select * from dbpedia where query = ?" query))))
~~~~~~~~
                      
This caching layer greatly speeds up my own personal use of KGN. Without caching, queries that contain many entity references simply take too long to run. The UI for the KGN applications in later chapters have a menu option for clearing the local cache but I almost never use this option because growing a large cache that is tailored for the types of information I search for makes the entire system much more responsive.


## Utilities in the Main Library File kgn-common.lisp

The utilities in the file **src/kgn-common/kgn-common.lisp** can be seen in this complete code listing:

{lang="lisp",linenos=on}
~~~~~~~~
(in-package #:kgn-common)

(defun pprint-results (results &key (stream t))
  (pprint results stream))

(defun colorize-sparql-local (s  &key (stream nil))
  "placeholder - some applications, like the kgn-capi-ui example need to
   colorize the sparql output"
  (princ s stream))

(defun check-uri (uri)
  "sloppy code fix: URIs have different forms - normalize these"
  (if (equal (type-of uri) 'cons) (setf uri (second uri)))
  (entity-uris:ensure-uri-brackets uri))

(defun clean-comment (comment-string)
  "When getting comment strings from DBPedia, there are parts
   that I remove for display"
  (let ((i1 (search "(" comment-string))
        (i2 (search ")" comment-string)))
    (if (and i1 i2 (> i2 i1) (> i1 0))
        (concatenate 'string (subseq comment-string 0 (- i1 1))
                             (subseq comment-string (+ i2 1)))
        (let ((j1 (search " / " comment-string)))
          (if j1
              (let ((j2 (search "/" comment-string :start2 (+ j1 2))))
                (if (and j1 j2 (> j2 j1) (< (+ j2 1) (length comment-string)))
                    (concatenate 'string (subseq comment-string 0 j1)
                                         (subseq comment-string (+ j2 1)))
                    comment-string))
              comment-string)
          comment-string))))

(defun clean-results (results)
  "This function is replaced when we later build GUI apps"
  results)

(defun get-name-and-description-for-uri (uri)
  (let* ((sparql
           (replace-all
            (format nil
  "select distinct ?name ?comment { @@ ~
    values ?nameProperty {<http://www.w3.org/2000/01/rdf-schema#label>
                          <http://xmlns.com/foaf/0.1/name> } . @@ ~
    ~A ?nameProperty ?name . @@ ~
    ~A <http://www.w3.org/2000/01/rdf-schema#comment>  ?comment  .
         FILTER  (lang(?comment) = 'en') . @@ ~
   } LIMIT 1" uri uri)
             "@@" " "))
          (results (sparql-cache:dbpedia sparql)))
    (list (second (assoc :name (car results)))
          (second (assoc :comment (car results))))))

;; (kgn-common::get-name-and-description-for-uri
;;   "<http://dbpedia.org/resource/Apple_Inc.>")

(defun ask-is-type-of (entity-uri type-value-uri) ;; both URIs expected to use surrounding < > brackets for SPARQL
  (let* ((sparql
           (format nil
              "ASK { ~A <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> ~A }"
              (check-uri entity-uri) (check-uri type-value-uri)))
         (results (sparql-cache:ask-dbpedia sparql)))
    (print sparql)
    results))

;; (kgn-common::ask-is-type-of
;;   "<http://dbpedia.org/resource/Apple_Inc.>"
;;   "<http://dbpedia.org/ontology/Company>")


(defun dbpedia-get-entities-by-name (name dbpedia-type schema-org-type
          &key (message-stream t)
               (colorize-sparql-function #'colorize-sparql-local))
  ;; http://www.w3.org/1999/02/22-rdf-syntax-ns#type <http://schema.org/Person>
  (let* ((sparql
           (format nil
"select distinct ?s ?comment { 
   ?s ?p \"~A\"@en . @@ ~
   ?s <http://www.w3.org/2000/01/rdf-schema#comment>  ?comment  . FILTER  (lang(?comment) = 'en') . @@ ~
   ?s <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> ~A . @@ ~
} LIMIT 15" name dbpedia-type))
         (results (sparql-cache:dbpedia (replace-all sparql "@@" " "))))
    (print results)
    (terpri message-stream)
    (format message-stream
      "Trying to get entity by name = ~A using SPARQL with type:"
      name dbpedia-type)
    (terpri message-stream)
    (apply colorize-sparql-function (list sparql :stream message-stream))
    (if (null results)
        (let* ((sparql2
                 (format nil
"select distinct ?s ?comment {
    ?s ?p \"~A\"@en . @@ ~
    ?s <http://www.w3.org/2000/01/rdf-schema#comment>  ?comment  . FILTER  (lang(?comment) = 'en') . @@ ~
    ?s <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> ~A . @@ ~
} LIMIT 15" name schema-org-type)))
          (format
           t
           "No results for ~A for last SPARQL query using type ~A so trying type ~A" name dbpedia-type schema-org-type)
          (terpri message-stream)
          (setf results (sparql-cache:dbpedia (replace-all sparql2 "@@" " ")))
          (if (null results)
              (format
               t
               "No results for ~A for last SPARQL query using type ~A"
               name schema-org-type)
              (let* ((filtered (remove-if
                                #'(lambda (x)
                                    (or
                                     (search "," (cadar x))
                                     (and
                                      (not (equal (first x) :comment))
                                      (not (search "/resource/" (cadar x))))))
                                results))
                     (uris (remove-duplicates
                            (map
                              'list
                              #'(lambda (x)
                                (list (concatenate 'string "<" (cadar x) ">") (cadadr x)))
                                 filtered) :test #'equal)))
                (format t "~%~%********** dbpedia-get-entities-by-name: uris:~%")
                (pprint uris) (terpri)
                uris))))
    results))

;; (kgn-common:dbpedia-get-entities-by-name
;;    "Bill Gates" "<http://dbpedia.org/ontology/Person>"
;;    "<http://schema.org/Person>" :message-stream nil)
;; in above, pass t for message-stream to see generated SPARQL queries

(defun dbpedia-get-person-detail (person-uri-raw
    &key (message-stream t)
         (colorize-sparql-function #'colorize-sparql-local))
  ;; http://dbpedia.org/ontology/birthPlace 
  (let* ((person-uri (check-uri person-uri-raw))
         (query
           (format nil
      "SELECT DISTINCT ?label ?comment@@ ~
        (GROUP_CONCAT (DISTINCT ?birthplace; SEPARATOR=' | ') AS ?birthplace) @@ ~
        (GROUP_CONCAT (DISTINCT ?almamater; SEPARATOR=' | ') AS ?almamater) @@ ~
        (GROUP_CONCAT (DISTINCT ?spouse; SEPARATOR=' | ') AS ?spouse) { @@ ~
         ~A <http://www.w3.org/2000/01/rdf-schema#comment>  ?comment .@@
              FILTER  (lang(?comment) = 'en') . @@ ~
        OPTIONAL { ~A <http://dbpedia.org/ontology/birthPlace> ?birthplace } . @@ ~
        OPTIONAL { ~A <http://dbpedia.org/ontology/almaMater> ?almamater } . @@ ~
        OPTIONAL { ~A <http://dbpedia.org/ontology/spouse> ?spouse } . @@ ~
        OPTIONAL { ~A  <http://www.w3.org/2000/01/rdf-schema#label> ?label .@@ ~
                FILTER  (lang(?label) = 'en') } @@ ~
      } LIMIT 10@@" person-uri person-uri person-uri person-uri person-uri))
         (results (sparql-cache:dbpedia  (replace-all query "@@" " "))))
    (format message-stream "~%SPARQL to get PERSON data for ~A:~%~%" person-uri)
    (apply colorize-sparql-function (list query :stream message-stream))
    (format message-stream "~%")
    ;;results))
    (clean-results results)))

;; (kgn-common:dbpedia-get-person-detail "<http://dbpedia.org/resource/Bill_Gates>")

(defun dbpedia-get-company-detail (company-uri-raw
     &key (message-stream t)
          (colorize-sparql-function #'colorize-sparql-local))
  (let* ((company-uri (check-uri company-uri-raw))
         (query
           (format nil
"SELECT DISTINCT ?label ?comment (GROUP_CONCAT (DISTINCT ?industry; SEPARATOR=' | ') AS ?industry)@@ ~
  (GROUP_CONCAT (DISTINCT ?netIncome; SEPARATOR=' | ') AS ?netIncome)@@ ~
  (GROUP_CONCAT (DISTINCT ?numberOfEmployees; SEPARATOR=' | ') AS ?numberOfEmployees) {@@ ~
  ~A <http://www.w3.org/2000/01/rdf-schema#comment>  ?comment .@@
          FILTER  (lang(?comment) = 'en') .@@ ~
  OPTIONAL { ~A <http://dbpedia.org/ontology/industry> ?industry } .@@  ~
  OPTIONAL { ~A <http://dbpedia.org/ontology/netIncome> ?netIncome } .@@  ~
  OPTIONAL { ~A <http://dbpedia.org/ontology/numberOfEmployees> ?numberOfEmployees } .@@  ~
  OPTIONAL { ~A <http://www.w3.org/2000/01/rdf-schema#label> ?label . FILTER (lang(?label) = 'en') } @@ ~
} LIMIT 30@@"
           company-uri company-uri company-uri company-uri company-uri))
         (results (sparql-cache:dbpedia  (replace-all query "@@" " "))))
    (format message-stream "~%SPARQL to get COMPANY data for ~A:~%~%" company-uri)
    (apply colorize-sparql-function (list query :stream message-stream))
    (format message-stream "~%")
    (clean-results results)))

;; (kgn-common:dbpedia-get-company-detail "<http://dbpedia.org/resource/Microsoft>")

(defun dbpedia-get-country-detail (country-uri-raw
    &key (message-stream t)
         (colorize-sparql-function #'colorize-sparql-local))
  (let* ((country-uri (check-uri country-uri-raw))
         (query
           (format nil
"SELECT DISTINCT ?label ?comment (GROUP_CONCAT (DISTINCT ?areaTotal; SEPARATOR=' | ') AS ?areaTotal)@@ ~
  (GROUP_CONCAT (DISTINCT ?populationDensity; SEPARATOR=' | ') AS ?populationDensity) {@@ ~
  ~A <http://www.w3.org/2000/01/rdf-schema#comment>  ?comment .@@
      FILTER  (lang(?comment) = 'en') .@@ ~
  OPTIONAL { ~A <http://dbpedia.org/ontology/areaTotal> ?areaTotal } .@@  ~
  OPTIONAL { ~A <http://dbpedia.org/ontology/populationDensity> ?populationDensity } .@@  ~
  OPTIONAL { ~A <http://www.w3.org/2000/01/rdf-schema#label> ?label . }@@ ~
} LIMIT 30@@"
                   country-uri country-uri country-uri country-uri country-uri))
         (results (sparql-cache:dbpedia  (replace-all query "@@" " "))))
    (format message-stream "~%SPARQL to get COUNTRY data for ~A:~%~%" country-uri)
    (apply colorize-sparql-function (list query :stream message-stream))
    (format message-stream "~%")
    (clean-results results)))

;; (kgn-common:dbpedia-get-country-detail "<http://dbpedia.org/resource/Canada>")

(defun dbpedia-get-city-detail (city-uri-raw
    &key (message-stream t)
         (colorize-sparql-function #'colorize-sparql-local))
  (let* ((city-uri (check-uri city-uri-raw))
         (query
           (format
            nil
"SELECT DISTINCT ?label ?comment @@ ~
  (GROUP_CONCAT (DISTINCT ?latitude_longitude; SEPARATOR=' | ')  AS ?latitude_longitude) @@ ~
  (GROUP_CONCAT (DISTINCT ?populationDensity; SEPARATOR=' | ') AS ?populationDensity) @@ ~
  (GROUP_CONCAT (DISTINCT ?country; SEPARATOR=' | ') AS ?country) { @@ ~
  ~A <http://www.w3.org/2000/01/rdf-schema#comment>  ?comment . FILTER  (lang(?comment) = 'en') . @@ ~
  OPTIONAL { ~A <http://www.w3.org/2003/01/geo/wgs84_pos#geometry> ?latitude_longitude } . @@ ~
  OPTIONAL { ~A <http://dbpedia.org/ontology/PopulatedPlace/populationDensity> ?populationDensity } . @@ ~
  OPTIONAL { ~A <http://dbpedia.org/ontology/country> ?country } .@@ ~
  OPTIONAL { ~A <http://www.w3.org/2000/01/rdf-schema#label> ?label . } @@ ~
} LIMIT 30@@"
            city-uri city-uri city-uri city-uri city-uri))
         (results (sparql-cache:dbpedia (replace-all query "@@" " "))))
    (format message-stream "~%SPARQL to get CITY data for ~A:~%~%" city-uri)
    (apply colorize-sparql-function (list query :stream message-stream))
    (format message-stream "~%")
    (clean-results results)))

;; (kgn-common:dbpedia-get-city-detail "<http://dbpedia.org/resource/London>")

(defun dbpedia-get-product-detail (product-uri-raw
     &key (message-stream t)
          (colorize-sparql-function #'colorize-sparql-local))
  (let* ((product-uri (check-uri product-uri-raw))
         (query
           (format
            nil
"SELECT DISTINCT ?label ?comment {  @@ ~
  ~A <http://www.w3.org/2000/01/rdf-schema#comment>  ?comment . FILTER  (lang(?comment) = 'en') . @@ ~
  OPTIONAL { ~A <http://www.w3.org/2000/01/rdf-schema#label> ?label . } ~
} LIMIT 30@@"
            product-uri product-uri))
         (results (sparql-cache:dbpedia (replace-all query "@@" " "))))
    (format message-stream "~%SPARQL to get PRODUCT data for ~A:~%~%" product-uri)
    (apply colorize-sparql-function (list query :stream message-stream))
    (format message-stream "~%")
    (clean-results results)))

;; (kgn-common:dbpedia-get-product-detail "<http://dbpedia.org/resource/Pepsi>")


(defun dbpedia-get-relationships (s-uri o-uri) ;;  &key (message-stream t))
  (let* ((query
           (format
            nil
"SELECT DISTINCT ?p { ~A ?p ~A . FILTER (!regex(str(?p), 'wikiPage', 'i'))} LIMIT 5"
            (check-uri s-uri) (check-uri  o-uri)))
         (results (sparql-cache:dbpedia query)))
    (alexandria:flatten (map 'list
                             #'(lambda (x)
                                 (format nil "~{<~A>~}" (cdar x)))
                             results))))

;; (kgn-common::dbpedia-get-relationships
;;   "<http://dbpedia.org/resource/Bill_Gates>"
;;   "<http://dbpedia.org/resource/Microsoft>")

(defun entities (text)
  (let ((txt-obj (kbnlp:make-text-object text)))
    (list (kbnlp::text-human-names txt-obj) (kbnlp::text-place-names txt-obj) (kbnlp::text-company-names txt-obj))))

;; (kgn-common::entities "Bill Clinton went to Canada")

(defun entities-dbpedia (text)
  (let ((e-hash (entity-uris:find-entities-in-text text)))
    (list
      (gethash "people" e-hash)
      (gethash "companies" e-hash)
      (gethash "countries" e-hash)
      (gethash "cities" e-hash))))

;; (kgn-common::entities-dbpedia "Bill Clinton went to Canada")
~~~~~~~~

## Wrap-up

This is a long example application for a book, split between this chapter and the next two chapters offering different user interface implementations.

I got the idea for the KGN application because I was spending quite a bit of time manually setting up SPARQL queries for DBPedia (and other public sources like WikiData) and I wanted to experiment with partially automating this process. Now in the next two chapters we will write user interfaces for this KGN common library.
